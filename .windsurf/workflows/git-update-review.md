---
description: 智能更新评审工作流
auto_execution_mode: 1
---

# 智能更新评审工作流

这个工作流通过组合多个 `git_command` 调用，来更新现有的评审提交。它会自动将当前的更改合并到上一个commit中，并重新提交到评审分支。

## 功能特性

- **无参数**: 不需要传递任何参数，自动检测和处理
- **智能合并**: 自动将当前更改合并到上一个commit
- **重新评审**: 自动推送更新后的commit到评审分支
- **安全检查**: 执行前会检查工作区状态和Git历史

## 工作流步骤

### 1. 检查工作区状态
首先检查当前工作区是否有未提交的更改：

```bash
git status --porcelain
```

### 2. 获取当前分支信息
// turbo
获取当前分支名称：

```bash
git branch --show-current
```

### 3. 检查最近的提交历史
// turbo
查看最近的提交，确保有可以修改的commit：

```bash
git log --oneline -3
```

### 4. 添加所有更改到暂存区
// turbo
将所有修改的文件添加到暂存区：

```bash
git add .
```

### 5. 获取暂存区文件列表
// turbo
获取暂存区中的文件列表，用于确认更改：

```bash
git diff --cached --name-only
```

### 6. 修改上一个commit
使用 `--amend` 将当前更改合并到上一个commit中：

```bash
git commit --amend --no-edit
```

### 7. 推送到评审分支
推送更新后的commit到Gerrit评审分支：

```bash
git push origin HEAD:refs/for/$(git branch --show-current)
```

## AI智能处理逻辑

AI会自动处理以下情况：

1. **状态检查**:
   - 确认工作区有未提交的更改
   - 确认当前分支有可修改的commit历史
   - 检查是否在正确的Git仓库中

2. **安全验证**:
   - 确保不会修改已经合并的commit
   - 验证推送权限和分支状态
   - 检查是否有冲突需要解决

3. **错误处理**:
   - 如果工作区干净（无更改），提示用户
   - 如果没有可修改的commit，给出建议
   - 如果推送失败，显示详细错误信息

## 使用场景

这个工作流适用于以下场景：

1. **代码评审反馈**: 根据评审意见修改代码后，需要更新原有的评审
2. **发现小问题**: 提交评审后发现小的错误或遗漏，需要快速修复
3. **格式调整**: 需要调整代码格式或注释，但不想创建新的commit
4. **测试补充**: 添加或修改测试用例来完善原有的功能commit

## 执行流程

1. **准备阶段**:
   - 修改需要更新的文件
   - 确保在正确的分支上

2. **自动执行**:
   - 工作流自动检查状态
   - 添加更改到暂存区
   - 修改上一个commit
   - 推送到评审分支

3. **完成确认**:
   - 确认推送成功
   - 检查评审系统中的更新

## 优势

- **高效**: 一键完成评审更新，无需手动输入复杂的Git命令
- **安全**: 内置多重检查，避免误操作
- **智能**: 自动检测环境和状态，无需用户配置
- **透明**: 每个步骤都有清晰的说明和执行反馈
- **Gerrit集成**: 完美支持Gerrit代码评审流程

## 注意事项

- **使用前提**: 确保上一个commit是你自己创建的，且还未被合并
- **网络要求**: 需要能够访问Git远程仓库
- **权限要求**: 需要有推送到评审分支的权限
- **分支状态**: 建议在功能分支上使用，避免在主分支上执行
- **备份建议**: 重要更改建议先创建备份分支

## 错误排查

如果执行过程中遇到问题：

1. **工作区无更改**: 确认确实有文件被修改
2. **无可修改commit**: 检查是否在正确的分支上
3. **推送失败**: 检查网络连接和推送权限
4. **冲突问题**: 先解决冲突再重新执行工作流